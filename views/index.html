<!DOCTYPE html>
<html>
  <head>
    <title>Welcome to the Anonymous Message Board!</title>
    <meta name="description" content="A cool thing made with glitch.com">
    <link id="favicon" rel="icon" href="https://hyperdev.com/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/public/homepage_style.css">
    <link rel="stylesheet" href="/public/general_style.css">
    <link rel="stylesheet" href="/public/navbar.css">
    <script src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
  </head>
  <body> 
    
    <nav id="navigator" class="navclass">
      <a href="/" class="nav-link active">Home</a>
      <a href="/all-boards" class="nav-link">All boards</a>
      <a href="/about" class="nav-link">About</a>
      <a href="/contact" class="nav-link">Contact</a>      
    </nav>

    <header class="homepageHeader">
      <h1>
        Anonymous Message Board
      </h1>
    </header>
    
    <h1 class="header center">
      Create a Board
    </h1>
    
    <form id="boardForm" class="boardFormClass" method="post" action="/api/createBoard/">
      <input class="boardCreator customFocus" type="text" placeholder="create a new board." name="board_name" maxlength="15">
      <input class="passwordInput customFocus" type="text" placeholder="password" name="new_board_password" maxlength="15">
      <input id="password_submit_button" class="submitButton" type="submit" value="Submit">
    </form>
    
    <h2 class="header">
      Most Recently Bumped Boards
    </h2>
    
    <div class="container">
      <div id="recentThreads"></div>      
    </div>

    
    <script>
      $(document).ready(function(){
        $(function(){
          $.ajax({
            type: "GET",
            url: "/api/recent",
            success: function(data){
             var boardThreads= [];
              data.forEach(function(ele) {              
                var thread = ['<div class="gap"></div><div class="board">'];
                thread.push('<div class="main">')
                thread.push('<p class="boardPost boardTop">Board: <a class="boardLink" href="/b/'+ele.board+'/">'+ele.board+'</a> Bumped on: '+ ele.bumped_on+'</p>');
                thread.push('<div class="thread"><form id="reportThread" class="inLine"><input type="hidden" name="report_id" value="'+ele._id+'"><input class="quickReplyButtons" type="submit" value="Report"></form>');
                thread.push('<form id="deleteThread" class="inLine"><input type="hidden" value="'+ele._id+'" name="thread_id" required=""><input type="text" placeholder="password" name="delete_password" maxlength="30" required=""><input class="quickReplyButtons" type="submit" value="Delete"></form>');
                thread.push('<h3>'+ele.text+'</h3>');
                thread.push('</div><div class="replies">');
                var hiddenCount = ele.threadCount - 1;
                if (hiddenCount < 1) { hiddenCount = 0 };
                thread.push('<h5>'+ele.threadCount+' threads total ('+hiddenCount+' hidden)- <a href="/b/'+ele.board+'/'+ele._id+'">See the full thread here</a>.</h5>');
                ele.replies.forEach(function(rep) {
                  thread.push('<div class="reply">')
                  thread.push('<p class="id">id: '+rep._id+' ('+rep.created_on+')</p>');
                  thread.push('<form id="reportReply"><input type="hidden" name="thread_id" value="'+ele._id+'"><input type="hidden" name="reply_id" value="'+rep._id+'"><input class="quickReplyButtons" type="submit" value="Report"></form>');
                  thread.push('<form id="deleteReply"><input type="hidden" value="'+ele._id+'" name="thread_id" required=""><input type="hidden" value="'+rep._id+'" name="reply_id" required=""><input type="text" placeholder="password" name="delete_password" required=""><input class="quickReplyButtons" type="submit" value="Delete"></form>');
                  thread.push('<p>'+rep.text+'</p>');
                  thread.push('</div>')
                });
                thread.push('<div class="newReply">')
                thread.push('<form action="/api/replies/'+ele.board+'/" method="post" id="newReply">');
                thread.push('<input type="hidden" name="thread_id" value="'+ele._id+'">');
                thread.push('<textarea class="textareaClass" rows="5" cols="80" type="text" placeholder="Quick reply..." name="text" maxlength="300" required=""></textarea><br>');
                thread.push('<input type="text" placeholder="password to delete" name="delete_password" required=""><input class="quickReplyButtons" type="submit" value="Submit">')
                thread.push('</form></div></div></div></div>')
                boardThreads.push(thread.join(''));
              });
              $('#recentThreads').html(boardThreads.join(''));
            }
         }
        );         
        });             
      });
    </script>
    <script>
      $(document).ready(function(){
        $("#boardForm").submit(function(event){
          var url = this.action;
          event.preventDefault();
          $.ajax({
            type: "POST",
            url: url,
            data: $(this).serialize(),
            success: function(data){              
              var postUrl = '/b/' + data.board+'/';
              var goto = confirm(data.message);
              if(goto){
                $(location).attr('href', postUrl);
              }               
            },
            error: function(data){
              alert(data.responseJSON.message)          
            }
          });
        });          
      })
    </script>
  </body>
</html>
